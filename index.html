
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered CSV Forecaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.7.4/dist/simple-statistics.min.js"></script>
    <!-- DataTables dependencies -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.run/@google/genai"
        }
      }
    </script>
    <style>
        .btn-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* bg-blue-700 */
        }
        .btn-primary:disabled {
            background-color: #4b5563; /* bg-gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .file-input-label {
            cursor: pointer; padding: 0.75rem 1.5rem; border-radius: 0.5rem; background-color: #374151;
            color: #d1d5db; transition: background-color 0.2s; border: 2px dashed #4b5563;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .file-input-label:hover {
            background-color: #4b5563; border-color: #6b7280;
        }
        #file-upload-input { display: none; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #2563eb;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader-sm {
            width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: #2563eb;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Datatables dark theme overrides */
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_processing, .dataTables_wrapper .dataTables_paginate {
            color: #9ca3af;
        }
        .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input {
            background-color: #374151; border: 1px solid #4b5563; color: white;
        }
        .dataTables_wrapper .dataTables_filter input { margin-left: 0.5rem; }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color: #9ca3af !important; border: 1px solid transparent; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current, .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background: #2563eb !important; border-color: #2563eb !important; color: white !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #4b5563 !important; border-color: #4b5563 !important; color: white !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled { color: #6b7280 !important; }
        #table-output table.dataTable.no-footer { border-bottom: 1px solid #374151; }
        #table-output table.dataTable thead th { border-bottom: 1px solid #4b5563; }
        #table-output table { width: 100%; border-collapse: collapse; }
        #table-output thead { background-color: #374151; }
        #table-output th, #table-output td { padding: 0.75rem 1rem; }
    </style>
</head>
<body class="bg-gray-900">
    <div class="min-h-screen w-full bg-gray-900 text-white flex items-center justify-center p-4 sm:p-6 lg:p-8 font-sans">
        <div class="w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-teal-300 text-transparent bg-clip-text">
                    AI-Powered CSV Forecaster
                </h1>
                <p class="mt-2 text-lg text-gray-400">
                    Upload your CSV data to get an instant analysis, forecast, and visualization from a team of AI agents.
                </p>
            </header>

            <div id="main-content" class="bg-gray-800/40 backdrop-blur-sm border border-gray-700/60 rounded-xl shadow-2xl p-4 sm:p-6">
                <!-- Upload Section -->
                <div id="upload-section">
                    <div class="text-center">
                        <h2 class="text-xl font-semibold text-gray-200 mb-4">Get Started</h2>
                        <div class="max-w-xl mx-auto">
                            <div class="mb-4">
                                <label for="api-key-input" class="block text-sm font-medium text-gray-400 mb-1 text-left">Google Gemini API Key</label>
                                <input type="password" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key here">
                            </div>
                             <input type="file" id="file-upload-input" accept=".csv">
                             <label for="file-upload-input" id="file-upload-label" class="file-input-label">
                                 <span id="file-upload-text">Click to upload a CSV file</span>
                             </label>
                             
                             <div class="my-6">
                                <h3 class="text-lg font-medium text-gray-300 mb-3 text-left">Configuration</h3>
                                <div class="space-y-4 text-left p-4 bg-gray-900/30 rounded-lg">
                                     <div>
                                        <label for="output-language" class="block text-sm font-medium text-gray-400">Output Language</label>
                                        <select id="output-language" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="English">English</option>
                                            <option value="Spanish">Spanish</option>
                                            <option value="French">French</option>
                                            <option value="German">German</option>
                                            <option value="Japanese">Japanese</option>
                                            <option value="Mandarin Chinese">Mandarin Chinese</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="agent1-model" class="block text-sm font-medium text-gray-400">Agent 1 (Data & Table Generator)</label>
                                        <select id="agent1-model" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="agent2-model" class="block text-sm font-medium text-gray-400">Agent 2 (Forecasting Specialist)</label>
                                        <select id="agent2-model" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="agent3-model" class="block text-sm font-medium text-gray-400">Agent 3 (Reasoning Analyst)</label>
                                        <select id="agent3-model" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="agent4-model" class="block text-sm font-medium text-gray-400">Agent 4 (Reporting Analyst)</label>
                                        <select id="agent4-model" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                             <button id="analyze-btn" class="w-full mt-4 py-3 px-4 rounded-lg font-semibold btn-primary" disabled>Analyze Data</button>
                        </div>
                    </div>
                </div>

                <!-- Skeleton Loading Section -->
                <div id="skeleton-section" class="hidden space-y-8">
                    <div class="text-center mb-6">
                        <div class="loader mx-auto"></div>
                        <p id="loading-status-text" class="mt-4 text-lg text-gray-400">AI agents are assembling...</p>
                    </div>
                    <div class="space-y-8 animate-pulse">
                        <div><div class="h-7 bg-gray-700 rounded w-48 mb-3"></div><div class="space-y-3"><div class="h-4 bg-gray-700 rounded w-full"></div><div class="h-4 bg-gray-700 rounded w-5/6"></div></div></div>
                        <div><div class="h-7 bg-gray-700 rounded w-64 mb-3"></div><div class="h-48 bg-gray-700 rounded-lg"></div></div>
                        <div><div class="h-7 bg-gray-700 rounded w-64 mb-3"></div><div class="h-96 bg-gray-700 rounded-lg"></div></div>
                        <div><div class="h-7 bg-gray-700 rounded w-64 mb-3"></div><div class="space-y-3"><div class="h-4 bg-gray-700 rounded w-full"></div><div class="h-4 bg-gray-700 rounded w-3/4"></div></div></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="hidden space-y-8" style="margin-top: 50px;">
                     <div id="summary-container" class="hidden">
                        <h3 class="text-2xl font-semibold text-gray-200 mb-3 border-b border-gray-700 pb-2">ERP Professional Summary</h3>
                        <div id="summary-loader" class="flex items-center space-x-3 py-4">
                            <div class="loader-sm"></div>
                            <p class="text-gray-400">Agent 4 is crafting the final summary...</p>
                        </div>
                        <p id="summary-output" class="text-gray-300 whitespace-pre-wrap hidden"></p>
                    </div>
                     <div id="table-container" class="hidden">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-3">
                           <h3 class="text-2xl font-semibold text-gray-200">Data Table</h3>
                           <button id="export-csv-btn" class="hidden text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Export to CSV</button>
                        </div>
                        <div id="table-output"></div>
                    </div>
                     <div id="chart-container" class="hidden">
                        <h3 class="text-2xl font-semibold text-gray-200 mb-3 border-b border-gray-700 pb-2">Statistical Forecast Chart</h3>
                        <div id="stat-chart-loader" class="flex items-center justify-center h-96 flex-col">
                            <div class="loader"></div>
                            <p class="text-gray-400 mt-4">Generating statistical forecast chart...</p>
                        </div>
                        <div id="stat-chart-wrapper" class="w-full h-96 hidden">
                            <canvas id="stat-forecast-chart"></canvas>
                        </div>
                    </div>
                    <div id="ai-chart-container" class="hidden mt-8">
                        <h3 class="text-2xl font-semibold text-gray-200 mb-3 border-b border-gray-700 pb-2">AI-Validated Forecast Chart</h3>
                        <div id="ai-chart-loader" class="flex items-center justify-center h-96 flex-col">
                            <div class="loader"></div>
                            <p class="text-gray-400 mt-4">Generating AI-validated forecast chart...</p>
                        </div>
                        <div id="ai-chart-wrapper" class="w-full h-96 hidden">
                            <canvas id="ai-forecast-chart"></canvas>
                        </div>
                    </div>
                    <div id="rationale-container" class="hidden">
                        <h3 class="text-2xl font-semibold text-gray-200 mb-3 border-b border-gray-700 pb-2">Forecast Rationale</h3>
                        <div id="rationale-loader" class="flex items-center space-x-3 py-4">
                             <div class="loader-sm"></div>
                             <p class="text-gray-400">Agent 3 is analyzing the forecast logic...</p>
                        </div>
                        <p id="rationale-output" class="text-gray-300 whitespace-pre-wrap hidden"></p>
                    </div>
                </div>
            </div>
            
            <footer class="text-center mt-8 text-gray-500 text-sm">
                <p>Analysis and forecasts are generated by AI and may not be perfect. Use for demonstration purposes.</p>
            </footer>
        </div>
    </div>
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

// IndexedDB setup for API key persistence
const DB_NAME = 'gemini_api_db';
const STORE_NAME = 'api_keys';

function openDb() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = () => {
            request.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function getApiKey() {
    return openDb().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const getReq = store.get(1);
        getReq.onsuccess = () => resolve(getReq.result?.key || '');
        getReq.onerror = () => reject(getReq.error);
    }));
}

function saveApiKey(key) {
    openDb().then(db => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.put({ id: 1, key });
    }).catch(console.error);
}

        document.addEventListener('DOMContentLoaded', () => {
            const apiKeyInput = document.getElementById('api-key-input');
            const fileUploadInput = document.getElementById('file-upload-input');
            const fileUploadLabelText = document.getElementById('file-upload-text');
            const analyzeBtn = document.getElementById('analyze-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const outputLanguageSelect = document.getElementById('output-language');
            
            const agent1ModelSelect = document.getElementById('agent1-model');
            const agent2ModelSelect = document.getElementById('agent2-model');
            const agent3ModelSelect = document.getElementById('agent3-model');
            const agent4ModelSelect = document.getElementById('agent4-model');
            
            const uploadSection = document.getElementById('upload-section');
            const skeletonSection = document.getElementById('skeleton-section');
            const loadingStatusText = document.getElementById('loading-status-text');
            const resultsSection = document.getElementById('results-section');

            const summaryContainer = document.getElementById('summary-container');
            const tableContainer = document.getElementById('table-container');
            const statChartContainer = document.getElementById('chart-container'); // Renamed from chart-container
            const aiChartContainer = document.getElementById('ai-chart-container'); // New AI chart container
            const rationaleContainer = document.getElementById('rationale-container');

            const summaryOutput = document.getElementById('summary-output');
            const tableOutput = document.getElementById('table-output');
            const rationaleOutput = document.getElementById('rationale-output');
            const statChartCanvas = document.getElementById('stat-forecast-chart'); // Renamed from forecast-chart
            const aiChartCanvas = document.getElementById('ai-forecast-chart'); // New AI chart canvas

            const summaryLoader = document.getElementById('summary-loader');
            const statChartLoader = document.getElementById('stat-chart-loader'); // Renamed from chart-loader
            const aiChartLoader = document.getElementById('ai-chart-loader'); // New AI chart loader
            const rationaleLoader = document.getElementById('rationale-loader');
            const statChartWrapper = document.getElementById('stat-chart-wrapper'); // Renamed from chart-wrapper
            const aiChartWrapper = document.getElementById('ai-chart-wrapper'); // New AI chart wrapper

            let csvData = null;
            let dataTableInstance = null;
            let fullChartDataForExport = null; // This will now be for the AI-validated chart
            let statChartDataForExport = null; // New variable for statistical chart export
            
            const updateButtonState = () => {
                const hasFile = !!csvData;
                const hasApiKey = apiKeyInput.value.trim() !== '';
                analyzeBtn.disabled = !(hasFile && hasApiKey);
            };

            const initChart = () => {
                if (forecastChart) forecastChart.destroy();
                forecastChart = new Chart(chartCanvas, {
                    type: 'line', data: { labels: [], datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#A0AEC0', font: { size: 14 }}},
                            tooltip: {
                                enabled: true, backgroundColor: 'rgba(17, 24, 39, 0.8)',
                                borderColor: '#4A5568', borderWidth: 1, padding: 12,
                                titleColor: '#E5E7EB', bodyColor: '#D1D5DB',
                                callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('en-US').format(c.parsed.y)}` }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }},
                            y: { border: { display: false }, grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }}
                        }
                    }
                });
            };

            fileUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type === "text/csv") {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        csvData = event.target.result;
                        fileUploadLabelText.textContent = file.name;
                        updateButtonState();
                    };
                    reader.readAsText(file);
                } else {
                    csvData = null;
                    fileUploadLabelText.textContent = "Please select a valid .csv file";
                    updateButtonState();
                }
            });
            
            apiKeyInput.addEventListener('input', (e) => {
    saveApiKey(e.target.value);
    updateButtonState();
});
getApiKey().then(key => {
    if (key) apiKeyInput.value = key;
    updateButtonState();
}).catch(console.error);

            const callAgent = async (ai, model, prompt, schema) => {
                const response = await ai.models.generateContent({
                    model: model,
                    contents: prompt,
                    config: { responseMimeType: "application/json", responseSchema: schema },
                });
                return JSON.parse(response.text);
            };

function generateStatisticalForecast(cleanedData) {
    const dataPoints = cleanedData.values.map((y, i) => [i, y]);
    const regression = ss.linearRegression(dataPoints);
    const regressionLine = ss.linearRegressionLine(regression);
    const forecast = [];
    for (let i = 0; i < 30; i++) {
        forecast.push(i === 0
            ? cleanedData.values[cleanedData.values.length - 1]
            : regressionLine(cleanedData.values.length + i - 1)
        );
    }
    return forecast;
}

const agent1_processAndTable = async (ai, rawCsv, model) => {
    loadingStatusText.textContent = `Agent 1 (${model}): Generating Table...`;
    const schema = {
        type: Type.OBJECT, properties: {
            tableHtml: { type: Type.STRING, description: "An HTML string representing the cleaned data in a table. The table MUST have an id='data-table-interactive' and include <thead> and <tbody> elements. Style it with these TailwindCSS classes: table with 'w-full text-sm text-left text-gray-400', thead with 'text-xs text-gray-300 uppercase bg-gray-700', and tbody tr with 'border-b border-gray-700'." },
            cleanedData: { type: Type.OBJECT, properties: { labels: { type: Type.ARRAY, items: { type: Type.STRING } }, values: { type: Type.ARRAY, items: { type: Type.NUMBER } }, }, required: ['labels', 'values'] },
        }, required: ['tableHtml', 'cleanedData']
    };
    const prompt = `You are a professional ERP data specialist at a leading enterprise software company. Your responsibility is to process raw CSV data with precision and rigor. Perform the following tasks: 1. Clean the data by accurately identifying the primary date/time column and the primary numerical value column, ensuring data integrity and consistency. 2. Generate a well-formatted, accessible, and visually clear HTML table of this cleaned data, adhering to enterprise UI standards. Return both the cleaned data in JSON format and the HTML table string.\n\n--- CSV DATA ---\n${rawCsv}`;
    return await callAgent(ai, model, prompt, schema);
};

            const agent2_validateForecast = async (ai, cleanedData, statisticalForecast, model) => {
    const schema = { type: Type.OBJECT, properties: { forecast: { type: Type.ARRAY, items: { type: Type.NUMBER }, description: "An array of AI-validated forecasted numerical values for the next 30 periods." } }, required: ['forecast'] };
    const prompt = `You are a professional forecasting specialist at a leading ERP company. Your task is to rigorously evaluate and refine the provided initial statistical forecast based on the historical data. Ensure the forecast is analytically sound, aligns with business trends, and the first forecast value exactly matches the last actual data point (${cleanedData.values[cleanedData.values.length - 1]}). Return a 30-period forecast array that reflects a realistic and data-driven projection.\n\n--- HISTORICAL DATA ---\n${JSON.stringify(cleanedData)}\n\n--- INITIAL STATISTICAL FORECAST ---\n${JSON.stringify(statisticalForecast)}`;
    return await callAgent(ai, model, prompt, schema);
};

const agent3_explainForecast = async (ai, cleanedData, forecastData, model, language) => {
    const schema = { type: Type.OBJECT, properties: { rationale: { type: Type.STRING, description: `A concise, easy-to-understand paragraph explaining the logic behind the forecast in ${language}. Analyze the historical data's trends (e.g., growth, seasonality, recent dips or spikes) and explain how the forecast is a logical extension of these patterns.` } }, required: ['rationale'] };
    const prompt = `You are a professional data reasoning analyst at a leading ERP company. Your task is to provide a clear, concise, and authoritative explanation of the forecast shown on the chart. Analyze the historical data's trends (e.g., growth, seasonality, recent dips or spikes) and explain how the forecast line logically extends these patterns, suitable for presentation to senior management. Your entire response must be in ${language}.\n\n--- HISTORICAL DATA ---\n${JSON.stringify(cleanedData)}\n\n--- FORECAST DATA ---\n${JSON.stringify(forecastData)}`;
    return await callAgent(ai, model, prompt, schema);
};
            
const agent4_generateSummary = async (ai, cleanedData, forecastData, rationale, model, language) => {
    const schema = { type: Type.OBJECT, properties: { summary: { type: Type.STRING, description: `A final, one-paragraph executive summary in ${language}. Combine the historical trends, the forecast projection, and the rationale behind the forecast into a single, cohesive narrative for a business audience.` } }, required: ['summary'] };
    const prompt = `You are a senior ERP professional reporting analyst at a top-tier enterprise software company. Your responsibility is to analyze the provided data table and forecast chart to craft a powerful, integrated executive summary suitable for high-level ERP system reports. Synthesize the key trends observed in the table and the projections from the chart, incorporating the forecast's reasoning, into a single, cohesive, polished, and professional narrative that is actionable for business stakeholders. Your entire response must be in ${language}.\n\n--- DATA FOR TABLE ---\n${JSON.stringify(cleanedData)}\n\n--- DATA FOR CHART ---\n${JSON.stringify(forecastData)}\n\n--- FORECAST RATIONALE ---\n${rationale}`;
    return await callAgent(ai, model, prompt, schema);
};

            const exportToCsv = () => {
                if (!fullChartDataForExport) return;
                let csvContent = `"Label","Actual","Forecast"\n`;
                fullChartDataForExport.labels.forEach((label, index) => {
                    const actual = fullChartDataForExport.actualData[index] ?? '';
                    const forecast = fullChartDataForExport.forecastData[index] ?? '';
                    if (actual !== '' || forecast !== '') {
                        csvContent += `"${label}","${actual}","${forecast}"\n`;
                    }
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "forecast_data.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            exportCsvBtn.addEventListener('click', exportToCsv);

            analyzeBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                const language = outputLanguageSelect.value;
                if (!csvData || !apiKey) return;

                // --- PHASE 1: SETUP ---
                uploadSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                skeletonSection.classList.remove('hidden');

                // Reset UI state from previous runs
                if (dataTableInstance) {
                    dataTableInstance.destroy();
                    dataTableInstance = null;
                }
                tableOutput.innerHTML = "";
                exportCsvBtn.classList.add('hidden');
                fullChartDataForExport = null;
                
                // Hide all result content and show loaders
                [summaryContainer, tableContainer, statChartContainer, aiChartContainer, rationaleContainer].forEach(c => c.classList.add('hidden'));
                
                summaryOutput.classList.add('hidden');
                summaryLoader.classList.remove('hidden');

                statChartWrapper.classList.add('hidden');
                statChartLoader.classList.remove('hidden');
                aiChartWrapper.classList.add('hidden');
                aiChartLoader.classList.remove('hidden');

                rationaleOutput.classList.add('hidden');
                rationaleLoader.classList.remove('hidden');

                loadingStatusText.textContent = 'Agent 1 is processing and cleaning your data...';

                try {
                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    const [model1, model2, model3, model4] = [agent1ModelSelect.value, agent2ModelSelect.value, agent3ModelSelect.value, agent4ModelSelect.value];
                    
                    // --- PHASE 2: AGENT 1 (TABLE) ---
                    const agent1_result = await agent1_processAndTable(ai, csvData, model1);
                    const cleanedData = agent1_result.cleanedData;
                    
                    // UI Update after Agent 1
                    skeletonSection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                    
                    tableContainer.classList.remove('hidden');
                    tableOutput.innerHTML = agent1_result.tableHtml;
                    dataTableInstance = $('#data-table-interactive').DataTable({ "pageLength": 10, "destroy": true });
                    
                    // Reveal other containers with loaders
                    statChartContainer.classList.remove('hidden');
                    aiChartContainer.classList.remove('hidden');
                    rationaleContainer.classList.remove('hidden');
                    summaryContainer.classList.remove('hidden');

                    // --- PHASE 3: STATISTICAL FORECAST ---
                    loadingStatusText.textContent = `Generating statistical forecast...`;
                    const statisticalForecast = generateStatisticalForecast(cleanedData);
                    const statForecastDisplayData = new Array(cleanedData.values.length).fill(null).concat(statisticalForecast);
                    const futureLabels = [...cleanedData.labels];
                    for (let i = 1; i <= statisticalForecast.length; i++) {
                        futureLabels.push(`Forecast ${i}`);
                    }
                    statChartDataForExport = { labels: futureLabels, actualData: cleanedData.values.concat(new Array(statisticalForecast.length).fill(null)), forecastData: statForecastDisplayData };
                    updateCharts(statChartDataForExport, null); // Update statistical chart first

                    statChartLoader.classList.add('hidden');
                    statChartWrapper.classList.remove('hidden');
                    
                // --- PHASE 4: AGENT 2 (VALIDATION) ---
                    loadingStatusText.textContent = `Agent 2 (${model2}): Validating Statistical Forecast...`;
                    const agent2_result = await agent2_validateForecast(ai, cleanedData, statisticalForecast, model2);
                    const aiValidatedForecastData = agent2_result.forecast;
                    
                    // UI Update after Agent 2
                    const aiForecastDisplayData = new Array(cleanedData.values.length).fill(null).concat(aiValidatedForecastData);
                    fullChartDataForExport = { labels: futureLabels, actualData: cleanedData.values.concat(new Array(aiValidatedForecastData.length).fill(null)), forecastData: aiForecastDisplayData };
                    updateCharts(statChartDataForExport, fullChartDataForExport); // Update both charts
                    
                    aiChartLoader.classList.add('hidden');
                    aiChartWrapper.classList.remove('hidden');
                    exportCsvBtn.classList.remove('hidden'); // Export button for AI-validated forecast

                    // --- PHASE 5: AGENT 3 (RATIONALE) ---
                    const agent3_result = await agent3_explainForecast(ai, cleanedData, aiValidatedForecastData, model3, language);
                    
                    // UI Update after Agent 3
                    rationaleOutput.textContent = agent3_result.rationale;
                    rationaleLoader.classList.add('hidden');
                    rationaleOutput.classList.remove('hidden');

                    // --- PHASE 6: AGENT 4 (SUMMARY) ---
                    const agent4_result = await agent4_generateSummary(ai, cleanedData, aiValidatedForecastData, agent3_result.rationale, model4, language);
                    
                    // UI Update after Agent 4
                    summaryOutput.textContent = agent4_result.summary;
                    summaryLoader.classList.add('hidden');
                    summaryOutput.classList.remove('hidden');

                    // --- PHASE 6: FINAL CLEANUP ---
                    uploadSection.classList.remove('hidden');

                } catch (error) {
                    console.error("Error during multi-agent analysis:", error);
                    alert("An error occurred. Check the console and verify your API key and data.");
                    resultsSection.classList.add('hidden'); 
                    uploadSection.classList.remove('hidden'); 
                } finally {
                    skeletonSection.classList.add('hidden');
                }
            });
            
            let statForecastChart = null;
            let aiForecastChart = null;

            const initCharts = () => {
                if (statForecastChart) statForecastChart.destroy();
                if (aiForecastChart) aiForecastChart.destroy();

                const statCtx = document.getElementById('stat-forecast-chart').getContext('2d');
                statForecastChart = new Chart(statCtx, {
                    type: 'line', data: { labels: [], datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#A0AEC0', font: { size: 14 }}},
                            tooltip: {
                                enabled: true, backgroundColor: 'rgba(17, 24, 39, 0.8)',
                                borderColor: '#4A5568', borderWidth: 1, padding: 12,
                                titleColor: '#E5E7EB', bodyColor: '#D1D5DB',
                                callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('en-US').format(c.parsed.y)}` }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }},
                            y: { border: { display: false }, grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }}
                        }
                    }
                });

                const aiCtx = document.getElementById('ai-forecast-chart').getContext('2d');
                aiForecastChart = new Chart(aiCtx, {
                    type: 'line', data: { labels: [], datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#A0AEC0', font: { size: 14 }}},
                            tooltip: {
                                enabled: true, backgroundColor: 'rgba(17, 24, 39, 0.8)',
                                borderColor: '#4A5568', borderWidth: 1, padding: 12,
                                titleColor: '#E5E7EB', bodyColor: '#D1D5DB',
                                callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('en-US').format(c.parsed.y)}` }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }},
                            y: { border: { display: false }, grid: { color: 'rgba(74, 85, 104, 0.5)' }, ticks: { color: '#A0AEC0' }}
                        }
                    }
                });
            };

            const updateCharts = (statChartData, aiChartData) => {
                statForecastChart.data.labels = statChartData.labels;
                statForecastChart.data.datasets = [{
                    label: 'Actual', data: statChartData.actualData, borderColor: '#38B2AC', backgroundColor: '#38B2AC',
                    tension: 0.4, pointRadius: 0, pointHoverRadius: 6,
                    spanGaps: true,
                }, {
                    label: 'Statistical Forecast', data: statChartData.forecastData, borderColor: '#F6AD55', backgroundColor: '#F6AD55',
                    borderDash: [5, 5], tension: 0.4, pointRadius: 0, pointHoverRadius: 6,
                    spanGaps: true,
                }];
                statForecastChart.update();

                if (aiChartData) {
                    aiForecastChart.data.labels = aiChartData.labels;
                    aiForecastChart.data.datasets = [{
                        label: 'Actual', data: aiChartData.actualData, borderColor: '#38B2AC', backgroundColor: '#38B2AC',
                        tension: 0.4, pointRadius: 0, pointHoverRadius: 6,
                        spanGaps: true,
                    }, {
                        label: 'AI-Validated Forecast', data: aiChartData.forecastData, borderColor: '#4299E1', backgroundColor: '#4299E1',
                        borderDash: [5, 5], tension: 0.4, pointRadius: 0, pointHoverRadius: 6,
                        spanGaps: true,
                    }];
                    aiForecastChart.update();
                }
            };

            initCharts();
        });
    </script>
</body>
</html>
